(function(a){if(!a){a=django.jQuery}a.fn.martor=function(){var d=a(this);var c=a(".main-martor");d.trigger("martor.init");var b=function(e){var j=null;var g=0;if(document.cookie&&document.cookie!==""){var h=document.cookie.split(";");for(g;g<h.length;g++){var f=jQuery.trim(h[g]);if(f.substring(0,e.length+1)===(e+"=")){j=decodeURIComponent(f.substring(e.length+1));break}}}return j};c.each(function(L,h){var Q=a(h).data("field-name");var f=a("#id_"+Q);var l="martor-"+Q;var e=ace.edit(l);var B=JSON.parse(f.data("enable-configs").replace(/'/g,'"'));e.setTheme("ace/theme/github");e.getSession().setMode("ace/mode/markdown");e.getSession().setUseWrapMode(true);e.$blockScrolling=Infinity;e.renderer.setScrollMargin(10,10);e.setAutoScrollEditorIntoView(true);e.setShowPrintMargin(false);e.setOptions({enableBasicAutocompletion:true,enableSnippets:true,enableLiveAutocompletion:true,enableMultiselect:false});if(B.living=="true"){a(h).addClass("enable-living")}var p={getCompletions:function(V,W,X,U,Y){var i=typeof(emojis)!="undefined"?emojis:[];var S=V.getSession().getTokenAt(X.row,X.column.count);var T=S.value.split(/\s+/);var R=T[T.length-1];if(R[0]==":"){Y(null,i.map(function(Z){return{caption:Z,value:Z.replace(":","")+" ",meta:"emoji"}}))}}};var H={getCompletions:function(R,V,X,T,W){var U=R.getSession().getTokenAt(X.row,X.column.count);var S=U.value.split(/\s+/);var i=S[S.length-1];if(i[0]=="@"&&i[1]=="["){username=i.replace(/([\@\[/\]/])/g,"");a.ajax({url:f.data("search-users-url"),data:{username:username,csrfmiddlewaretoken:b("csrftoken")},success:function(aa){if(aa.status==200){var Y=[];for(var Z=0;Z<aa.data.length;Z++){Y.push(aa.data[Z].username)}W(null,Y.map(function(ab){return{caption:ab,value:ab,meta:"username"}}))}}})}}};if(B.mention==="true"){e.completers=[p,H]}else{e.completers=[p]}f.attr({style:"display:none"});a(h).find(".martor-toolbar").find(".markdown-selector").attr({"data-field-name":Q});a(h).find(".upload-progress").attr({"data-field-name":Q});a(h).find(".modal-help-guide").attr({"data-field-name":Q});a(h).find(".modal-emoji").attr({"data-field-name":Q});e.on("change",function(i){var R=e.getValue();f.val(R)});a("#"+l).resizable({direction:"bottom",stop:function(){e.resize()}});var J=a(".tab.segment[data-tab=preview-tab-"+Q+"]");var C=a(".item[data-tab=preview-tab-"+Q+"]");var t=function(){var R=e.getValue();var i=new FormData();i.append("content",R);i.append("csrfmiddlewaretoken",b("csrftoken"));a.ajax({url:f.data("markdownfy-url"),type:"POST",data:i,processData:false,contentType:false,success:function(S){if(S){J.html(S);a("pre").each(function(T,U){hljs.highlightBlock(U)})}else{J.html("<p>Nothing to preview</p>")}},error:function(S){console.log("error",S)}})};if(B.living==="true"){e.on("change",t)}else{C.click(function(){a(this).closest(".tab-martor-menu").find(".martor-toolbar").hide();t()})}var z=a(".item[data-tab=editor-tab-"+Q+"]");z.click(function(){a(this).closest(".tab-martor-menu").find(".martor-toolbar").show()});var q=function(R){console.log("markdownToBold");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U," **** ");R.focus();R.selection.moveTo(U.row,U.column+3)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"**"+T+"**");S.end.column+=4;R.focus();R.selection.setSelectionRange(S)}};var M=function(R){console.log("markdownToItalic");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U," __ ");R.focus();R.selection.moveTo(U.row,U.column+2)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"_"+T+"_");S.end.column+=2;R.focus();R.selection.setSelectionRange(S)}};var s=function(R){console.log("markdownToUnderscores");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U," ++++ ");R.focus();R.selection.moveTo(U.row,U.column+3)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"++"+T+"++");S.end.column+=4;R.focus();R.selection.setSelectionRange(S)}};var N=function(R){console.log("markdownToStrikethrough");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U," ~~~~ ");R.focus();R.selection.moveTo(U.row,U.column+3)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"~~"+T+"~~");S.end.column+=4;R.focus();R.selection.setSelectionRange(S)}};var F=function(R){console.log("markdownToHorizontal");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U,"\n\n----------\n\n");R.focus();R.selection.moveTo(U.row+4,U.column+10)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"\n\n----------\n\n"+T);R.focus();R.selection.moveTo(S.end.row+4,S.end.column+10)}};var x=function(R){console.log("markdownToH1");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U,"\n\n# ");R.focus();R.selection.moveTo(U.row+2,U.column+2)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"\n\n# "+T+"\n");R.focus();R.selection.moveTo(S.end.row+2,S.end.column+2)}};var w=function(R){console.log("markdownToH2");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U,"\n\n## ");R.focus();R.selection.moveTo(U.row+2,U.column+3)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"\n\n## "+T+"\n");R.focus();R.selection.moveTo(S.end.row+2,S.end.column+3)}};var v=function(R){console.log("markdownToH3");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U,"\n\n### ");R.focus();R.selection.moveTo(U.row+2,U.column+4)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"\n\n### "+T+"\n");R.focus();R.selection.moveTo(S.end.row+2,S.end.column+4)}};var k=function(R){console.log("markdownToPre");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U,"\n\n```\n\n```\n");R.focus();R.selection.moveTo(U.row+3,U.column)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"\n\n```\n"+T+"\n```\n");R.focus();R.selection.moveTo(S.end.row+3,S.end.column+3)}};var r=function(R){console.log("markdownToCode");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U," `` ");R.focus();R.selection.moveTo(U.row,U.column+2)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"`"+T+"`");S.end.column+=2;R.focus();R.selection.setSelectionRange(S)}};var G=function(R){console.log("markdownToBlockQuote");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U,"\n\n> \n");R.focus();R.selection.moveTo(U.row+2,U.column+2)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"\n\n> "+T+"\n");R.focus();R.selection.moveTo(S.end.row+2,S.end.column+2)}};var O=function(R){console.log("markdownToUnorderedList");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U,"\n\n* ");R.focus();R.selection.moveTo(U.row+2,U.column+2)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"\n\n* "+T);R.focus();R.selection.moveTo(S.end.row+2,S.end.column+2)}};var j=function(R){console.log("markdownToOrderedList");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U,"\n\n1. ");R.focus();R.selection.moveTo(U.row+2,U.column+3)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"\n\n1. "+T);R.focus();R.selection.moveTo(S.end.row+2,S.end.column+3)}};var u=function(R){console.log("markdownToLink");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U," [](http://) ");R.focus();R.selection.moveTo(U.row,U.column+2)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"["+T+"](http://) ");R.focus();R.selection.moveTo(S.end.row,S.end.column+10)}};var g=function(R,V){var S=R.getSelectionRange();if(typeof(V)==="undefined"){if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U," ![](http://) ");R.focus();R.selection.moveTo(U.row,U.column+3)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"!["+T+"](http://) ");R.focus();R.selection.moveTo(S.end.row,S.end.column+11)}}else{var U=R.getCursorPosition();R.session.insert(U,"!["+V.name+"]("+V.link+") ");R.focus();R.selection.moveTo(U.row,U.column+V.name.length+2)}};var y=function(R){console.log("markdownToMention");var S=R.getSelectionRange();if(R.selection.isEmpty()){var U=R.getCursorPosition();R.session.insert(U," @[]");R.focus();R.selection.moveTo(U.row,U.column+3)}else{var i=R.getSelectionRange();var T=R.session.getTextRange(i);R.session.replace(i,"@["+T+"]");R.focus();R.selection.moveTo(S.end.row,S.end.column+3)}};var I=function(R,i){var S=R.getCursorPosition();R.session.insert(S," "+i+" ");R.focus();R.selection.moveTo(S.row,S.column+i.length+2)};var K=function(i){console.log("markdownToUploadImage");console.log("Martor: Image upload");var T=a("#"+l).closest("form").get(0);var S=i.container.id.replace("martor-","");var R=new FormData(T);R.append("csrfmiddlewaretoken",b("csrftoken"));a.ajax({url:f.data("upload-url"),type:"POST",data:R,async:true,cache:false,contentType:false,enctype:"multipart/form-data",processData:false,beforeSend:function(){console.log("Uploading...");a(".upload-progress[data-field-name="+S+"]").show()},success:function(U){a(".upload-progress[data-field-name="+S+"]").hide();if(U.status==200){console.log(U);g(i=i,imageData={name:U.name,link:U.link})}else{alert(U.error)}},error:function(U){console.log("error",U);a(".upload-progress[data-field-name="+S+"]").hide()}});return false};e.commands.addCommand({name:"markdownToBold",bindKey:{win:"Ctrl-B",mac:"Command-B"},exec:function(i){q(i)},readOnly:true});e.commands.addCommand({name:"markdownToItalic",bindKey:{win:"Ctrl-I",mac:"Command-I"},exec:function(i){M(i)},readOnly:true});e.commands.addCommand({name:"markdownToUnderscores",bindKey:{win:"Ctrl-Shift-U",mac:"Command-Option-U"},exec:function(i){s(i)},readOnly:true});e.commands.addCommand({name:"markdownToStrikethrough",bindKey:{win:"Ctrl-Shift-S",mac:"Command-Option-S"},exec:function(i){N(i)},readOnly:true});e.commands.addCommand({name:"markdownToHorizontal",bindKey:{win:"Ctrl-H",mac:"Command-H"},exec:function(i){F(i)},readOnly:true});e.commands.addCommand({name:"markdownToH1",bindKey:{win:"Ctrl-Alt-1",mac:"Command-Option-1"},exec:function(i){x(i)},readOnly:true});e.commands.addCommand({name:"markdownToH2",bindKey:{win:"Ctrl-Alt-2",mac:"Command-Option-3"},exec:function(i){w(i)},readOnly:true});e.commands.addCommand({name:"markdownToH3",bindKey:{win:"Ctrl-Alt-3",mac:"Command-Option-3"},exec:function(i){v(i)},readOnly:true});e.commands.addCommand({name:"markdownToPre",bindKey:{win:"Ctrl-Alt-P",mac:"Command-Option-P"},exec:function(i){k(i)},readOnly:true});e.commands.addCommand({name:"markdownToCode",bindKey:{win:"Ctrl-Alt-C",mac:"Command-Option-C"},exec:function(i){r(i)},readOnly:true});e.commands.addCommand({name:"markdownToBlockQuote",bindKey:{win:"Ctrl-Q",mac:"Command-Q"},exec:function(i){G(i)},readOnly:true});e.commands.addCommand({name:"markdownToUnorderedList",bindKey:{win:"Ctrl-U",mac:"Command-U"},exec:function(i){O(i)},readOnly:true});e.commands.addCommand({name:"markdownToOrderedList",bindKey:{win:"Ctrl-Shift+O",mac:"Command-Option-O"},exec:function(i){j(i)},readOnly:true});e.commands.addCommand({name:"markdownToLink",bindKey:{win:"Ctrl-L",mac:"Command-L"},exec:function(i){u(i)},readOnly:true});e.commands.addCommand({name:"markdownToImageLink",bindKey:{win:"Ctrl-Shift-I",mac:"Command-Option-I"},exec:function(i){g(i)},readOnly:true});if(B.mention==="true"){e.commands.addCommand({name:"markdownToMention",bindKey:{win:"Ctrl-M",mac:"Command-M"},exec:function(i){y(i)},readOnly:true})}a(".markdown-bold[data-field-name="+Q+"]").click(function(){q(e)});a(".markdown-italic[data-field-name="+Q+"]").click(function(){M(e)});a(".markdown-horizontal[data-field-name="+Q+"]").click(function(){F(e)});a(".markdown-h1[data-field-name="+Q+"]").click(function(){x(e)});a(".markdown-h2[data-field-name="+Q+"]").click(function(){w(e)});a(".markdown-h3[data-field-name="+Q+"]").click(function(){v(e)});a(".markdown-pre[data-field-name="+Q+"]").click(function(){k(e)});a(".markdown-code[data-field-name="+Q+"]").click(function(){r(e)});a(".markdown-blockquote[data-field-name="+Q+"]").click(function(){G(e)});a(".markdown-unordered-list[data-field-name="+Q+"]").click(function(){O(e)});a(".markdown-ordered-list[data-field-name="+Q+"]").click(function(){j(e)});a(".markdown-link[data-field-name="+Q+"]").click(function(){u(e)});a(".markdown-image-link[data-field-name="+Q+"]").click(function(){g(e)});var E=a(".markdown-direct-mention[data-field-name="+Q+"]");var m=a(".markdown-image-upload[data-fieldname="+Q+"]");if(B.mention==="true"&&B.imgur==="true"){E.click(function(){y(e)});m.on("change",function(i){i.preventDefault();K(e)})}else{if(B.mention==="true"&&B.imgur==="false"){E.click(function(){y(e)});m.remove()}else{if(B.mention==="false"&&B.imgur==="true"){E.remove();m.on("change",function(i){i.preventDefault();K(e)})}else{E.remove();m.remove();a(".markdown-reference tbody tr")[1].remove()}}}a(".markdown-help[data-field-name="+Q+"]").click(function(){a(".modal-help-guide[data-field-name="+Q+"]").modal("show")});var D=a(h);var A=a(".martor-field-"+Q);var o=a(".markdown-toggle-maximize[data-field-name="+Q+"]");var P=function(){a(document.body).removeClass("overflow");a(this).attr({title:"Full Screen"});a(this).find(".minimize.icon").removeClass("minimize").addClass("maximize");a(".main-martor-fullscreen").find(".martor-preview").removeAttr("style");D.removeClass("main-martor-fullscreen");A.removeAttr("style");e.resize()};var n=function(i){i.attr({title:"Minimize"});i.find(".maximize.icon").removeClass("maximize").addClass("minimize");D.addClass("main-martor-fullscreen");var R=document.body.clientHeight-90;A.attr({style:"height:"+R+"px"});var S=a(".main-martor-fullscreen").find(".martor-preview");S.attr({style:"overflow-y: auto;height:"+R+"px"});e.resize();i.one("click",P);a(document.body).addClass("overflow")};o.on("click",function(){n(a(this))});a(document).keyup(function(i){if(i.keyCode==27&&D.hasClass("main-martor-fullscreen")){a(".minimize.icon").trigger("click")}});a(".markdown-emoji[data-field-name="+Q+"]").click(function(){var S=a(".modal-emoji[data-field-name="+Q+"]");var T=typeof(emojis)!="undefined"?emojis:[];var i=S.find(".emoji-content-body");var R=S.find(".emoji-loader-init");i.html("");R.show();S.modal({onVisible:function(){for(var U=0;U<T.length;U++){var V=f.data("base-emoji-url")+T[U].replace(/:/g,"")+".png";i.append('<div class="four wide column"><p><a data-emoji-target="'+T[U]+'" class="insert-emoji"><img class="marked-emoji" src="'+V+'"> '+T[U]+"</a></p></div>");a('a[data-emoji-target="'+T[U]+'"]').click(function(){I(e,a(this).data("emoji-target"));S.modal("hide",100)})}R.hide();S.modal("refresh")}}).modal("show")});if(f.val()!=""){e.setValue(f.val(),-1)}})};a(function(){a(".martor").martor()})})(jQuery);$(document).ready(function(){$(".ui.martor-toolbar .ui.dropdown").dropdown();$(".ui.tab-martor-menu .item").tab()});